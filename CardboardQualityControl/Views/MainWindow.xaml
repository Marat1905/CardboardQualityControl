<Window x:Class="CardboardQualityControl.Views.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:local="clr-namespace:CardboardQualityControl"
        xmlns:models="clr-namespace:CardboardQualityControl.Models"
        xmlns:converters="clr-namespace:CardboardQualityControl.Converters"
        mc:Ignorable="d"
        Title="Cardboard Quality Control System" 
        Height="900" 
        Width="1400"
        WindowStartupLocation="CenterScreen">

    <Window.Resources>
        <BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>
        <converters:DefectToBrushConverter x:Key="DefectToBrushConverter"/>
        <converters:VideoSourceTypeToStringConverter x:Key="VideoSourceTypeConverter"/>
        <converters:DefectTypeToStringConverter x:Key="DefectTypeConverter"/>
        <converters:NullToVisibilityConverter x:Key="NullToVisibilityConverter"/>
        <converters:BooleanToColorConverter x:Key="BooleanToColorConverter"/>
        <converters:DefectToStatusColorConverter x:Key="DefectToStatusColorConverter"/>
        <converters:BooleanToNotConverter x:Key="BooleanToNotConverter"/>
        <converters:BooleanToStringConverter x:Key="BooleanToStringConverter"/>
        <converters:FileVideoVisibilityConverter x:Key="FileVideoVisibilityConverter"/>

        <Style TargetType="Button">
            <Setter Property="Margin" Value="4"/>
            <Setter Property="Padding" Value="8,4"/>
            <Setter Property="MinWidth" Value="80"/>
        </Style>

        <Style TargetType="TextBlock">
            <Setter Property="Margin" Value="4"/>
            <Setter Property="VerticalAlignment" Value="Center"/>
        </Style>

        <Style TargetType="GroupBox">
            <Setter Property="Margin" Value="5"/>
            <Setter Property="Padding" Value="5"/>
        </Style>

        <Style TargetType="ComboBox">
            <Setter Property="Margin" Value="4"/>
            <Setter Property="MinWidth" Value="120"/>
        </Style>

        <!-- DataTemplate для ComboBox -->
        <DataTemplate x:Key="VideoSourceTypeTemplate">
            <TextBlock Text="{Binding Converter={StaticResource VideoSourceTypeConverter}}"/>
        </DataTemplate>
    </Window.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Header -->
        <Border Grid.Row="0" Background="#FF1976D2" Padding="10">
            <StackPanel Orientation="Horizontal">
                <TextBlock Text="📦 " FontSize="20" VerticalAlignment="Center"/>
                <TextBlock Text="Система контроля качества картона" 
                         FontSize="18" 
                         FontWeight="Bold" 
                         Foreground="White"
                         VerticalAlignment="Center"/>
            </StackPanel>
        </Border>

        <!-- Main Content -->
        <Grid Grid.Row="1">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="300"/>
            </Grid.ColumnDefinitions>

            <!-- Video Display Area -->
            <Border Grid.Column="0" 
                    BorderBrush="#FFCCCCCC" 
                    BorderThickness="1" 
                    Margin="10"
                    Background="#FF2D2D30">
                <Grid>
                    <Image Source="{Binding CurrentFrame}" 
                           Stretch="Uniform"
                           HorizontalAlignment="Center"
                           VerticalAlignment="Center"/>

                    <!-- Overlay when no video -->
                    <Border Background="#80000000" 
                            Visibility="{Binding CurrentFrame, Converter={StaticResource NullToVisibilityConverter}}"
                            HorizontalAlignment="Stretch"
                            VerticalAlignment="Stretch">
                        <TextBlock Text="No video signal" 
                                   Foreground="White"
                                   FontSize="16"
                                   HorizontalAlignment="Center"
                                   VerticalAlignment="Center"/>
                    </Border>
                </Grid>
            </Border>

            <!-- Control Panel -->
            <StackPanel Grid.Column="1" Margin="0,10,10,10">
                <!-- Video Source Selection -->
                <GroupBox Header="Video Source">
                    <StackPanel>
                        <ComboBox ItemsSource="{Binding AvailableVideoSources}" 
                                  SelectedItem="{Binding SelectedVideoSource}"
                                  ItemTemplate="{StaticResource VideoSourceTypeTemplate}"/>

                        <Button Content="Переключить источник" 
                                Command="{Binding SwitchVideoSourceCommand}"
                                CommandParameter="{Binding SelectedVideoSource}"
                                Margin="0,8,0,0"
                                Background="#FF2196F3"
                                Foreground="White"/>

                        <!-- Кнопка выбора файла -->
                        <Button Content="Выберите видеофайл" 
                                Command="{Binding SelectVideoFileCommand}"
                                Margin="0,8,0,0"
                                Background="#FF9C27B0"
                                Foreground="White"
                                Visibility="{Binding IsFileVideoSelected, Converter={StaticResource BooleanToVisibilityConverter}}"/>

                        <!-- Отображение пути к файлу -->
                        <TextBlock Text="{Binding CurrentVideoPath}" 
                                   Margin="0,8,0,0"
                                   TextWrapping="Wrap"
                                   FontStyle="Italic"
                                   FontSize="10"
                                   MaxHeight="40"
                                   TextTrimming="CharacterEllipsis"
                                   Visibility="{Binding IsFileVideoSelected, Converter={StaticResource BooleanToVisibilityConverter}}"/>
                    </StackPanel>
                </GroupBox>

                <!-- Monitoring Controls -->
                <GroupBox Header="Monitoring" Margin="0,10,0,0">
                    <StackPanel>
                        <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                            <Button Content="Старт" 
                                    Command="{Binding StartMonitoringCommand}"
                                    Background="#FF4CAF50"
                                    Foreground="White"
                                    IsEnabled="{Binding IsMonitoring, Converter={StaticResource BooleanToNotConverter}}"/>

                            <Button Content="Стоп" 
                                    Command="{Binding StopMonitoringCommand}"
                                    Background="#FFF44336"
                                    Foreground="White"
                                    IsEnabled="{Binding IsMonitoring}"/>
                        </StackPanel>

                        <Button Content="Захватить обучающее изображение" 
                                Command="{Binding CaptureTrainingImageCommand}"
                                Margin="0,8,0,0"
                                Background="#FFFF9800"
                                Foreground="White"
                                IsEnabled="{Binding IsMonitoring}"/>
                    </StackPanel>
                </GroupBox>

                <!-- Status Information -->
                <GroupBox Header="Статус" Margin="0,10,0,0">
                    <StackPanel>
                        <TextBlock Text="{Binding StatusMessage}" 
                                   FontWeight="Bold"
                                   TextWrapping="Wrap"
                                   Foreground="{Binding HasDefect, Converter={StaticResource DefectToStatusColorConverter}}"/>

                        <ProgressBar Height="4" 
                                     Margin="0,4,0,0"
                                     IsIndeterminate="{Binding IsMonitoring}"
                                     Visibility="{Binding IsMonitoring, Converter={StaticResource BooleanToVisibilityConverter}}"/>

                        <StackPanel Orientation="Horizontal" Margin="0,8,0,0">
                            <TextBlock Text="Мониторинг:"/>
                            <TextBlock Text="{Binding IsMonitoring}" 
                                       Foreground="{Binding IsMonitoring, Converter={StaticResource BooleanToColorConverter}}"
                                       Margin="8,0,0,0"/>
                        </StackPanel>
                    </StackPanel>
                </GroupBox>

                <!-- Defect Information -->
                <GroupBox Header="Обнаружение дефектов" Margin="0,10,0,0">
                    <StackPanel>
                        <Border Background="{Binding HasDefect, Converter={StaticResource DefectToBrushConverter}}"
                                CornerRadius="4"
                                Padding="8"
                                Margin="0,0,0,8">
                            <TextBlock Text="{Binding HasDefect, Converter={StaticResource BooleanToStringConverter}}" 
                                       HorizontalAlignment="Center"
                                       FontWeight="Bold"
                                       Foreground="White"/>
                        </Border>

                        <StackPanel Orientation="Horizontal">
                            <TextBlock Text="Тип:"/>
                            <TextBlock Text="{Binding CurrentDefect.DefectType, Converter={StaticResource DefectTypeConverter}}"
                                       Margin="8,0,0,0"
                                       FontWeight="Bold"/>
                        </StackPanel>

                        <StackPanel Orientation="Horizontal" Margin="0,4,0,0">
                            <TextBlock Text="Уверенность:"/>
                            <TextBlock Text="{Binding CurrentDefect.Confidence, StringFormat='{}{0:P1}'}"
                                       Margin="8,0,0,0"
                                       FontWeight="Bold"/>
                        </StackPanel>

                        <StackPanel Orientation="Horizontal" Margin="0,8,0,0">
                            <TextBlock Text="Всего дефектов:"/>
                            <TextBlock Text="{Binding DefectCount}"
                                       Margin="8,0,0,0"
                                       FontWeight="Bold"/>
                        </StackPanel>

                        <StackPanel Orientation="Horizontal" Margin="0,4,0,0">
                            <TextBlock Text="Обработано кадров:"/>
                            <TextBlock Text="{Binding TotalFramesProcessed}"
                                       Margin="8,0,0,0"
                                       FontWeight="Bold"/>
                        </StackPanel>
                    </StackPanel>
                </GroupBox>

                <!-- Quick Actions -->
                <GroupBox Header="Быстрые действия" Margin="0,10,0,0">
                    <StackPanel>
                        <Button Content="Открытый диалоговое окно обучения" 
                                Command="{Binding OpenTrainingDialogCommand}"
                                Background="#FF9C27B0"
                                Foreground="White"/>

                        <Button Content="Сбросить счетчики" 
                                Command="{Binding ResetCountersCommand}"
                                Margin="0,8,0,0"
                                Background="#FF607D8B"
                                Foreground="White"/>
                    </StackPanel>
                </GroupBox>
            </StackPanel>
        </Grid>

        <!-- Status Bar -->
        <StatusBar Grid.Row="2" Background="#FFE0E0E0">
            <StatusBarItem>
                <TextBlock Text="{Binding SelectedVideoSource, Converter={StaticResource VideoSourceTypeConverter}}"/>
            </StatusBarItem>

            <Separator/>

            <StatusBarItem>
                <TextBlock Text="{Binding IsMonitoring, StringFormat='Monitoring: {0}'}"/>
            </StatusBarItem>

            <Separator/>

            <StatusBarItem>
                <TextBlock Text="{Binding DefectCount, StringFormat='Defects: {0}'}"/>
            </StatusBarItem>

            <Separator/>

            <StatusBarItem>
                <TextBlock Text="{Binding TotalFramesProcessed, StringFormat='Frames: {0}'}"/>
            </StatusBarItem>

            <Separator/>

            <StatusBarItem>
                <TextBlock Text="{Binding CurrentDefect.DefectType, Converter={StaticResource DefectTypeConverter}}"/>
            </StatusBarItem>
        </StatusBar>
    </Grid>
</Window>